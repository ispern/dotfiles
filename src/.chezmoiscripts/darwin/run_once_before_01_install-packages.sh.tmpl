{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash

set -eufo pipefail

# Ensure Homebrew is in PATH
if [ -d "/opt/homebrew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install packages using Brewfile.darwin
echo "Installing packages from Brewfile.darwin..."

# Navigate to the chezmoi source directory
cd {{ .chezmoi.sourceDir | quote }}/../

if [ -f "Brewfile.darwin" ]; then
    brew bundle --file=Brewfile.darwin
else
    echo "Brewfile.darwin not found. Skipping package installation."
fi

# Set fish as default shell if not already set
if [ "$SHELL" != "$(which fish)" ]; then
    echo "Setting fish as default shell..."
    if ! grep -q "$(which fish)" /etc/shells; then
        echo "$(which fish)" | sudo tee -a /etc/shells
    fi
    chsh -s "$(which fish)"
fi

{{ end -}}